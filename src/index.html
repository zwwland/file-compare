<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      .files {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
      }
      .images {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
      }
      .images img {
        height: 240px;
      }
      .item {
        width: 100%;
        height: 300px;
        display: flex;
        flex-direction: row;
        justify-content: space-around;
      }
      .item div {
        width: 35%;
        height: 300px;
        border: 1px solid;
        box-sizing: border-box;
        overflow: scroll;
      }
      .red {
        color: red;
      }
      .green {
        color: green;
      }
      /* .item div:nth-child(1) { */
      /* border-color: red; */
      /* } */
      /* .item div:nth-child(2) { */
      /* border-color: green; */
      /* } */
    </style>
  </head>
  <body>
    <p class="files">
      <span>原：<input type="file" name="source" /></span>
      |
      <span>新：<input type="file" name="new" /></span>
    </p>
    <div class="images">
      <img class="image-source" />
      <img class="image-new" />
    </div>
    <hr />
    对比结果：(其中：<span class="red">红色删除的</span> |
    <span class="green">绿色新增的</span>)
    <div class="item">
      <div class="item-source"></div>
      <div class="item-new"></div>
    </div>
    <script src="/diff.js"></script>
    <script>
      !(function () {
        const files = document.querySelectorAll(".files input");
        files.forEach((f, i) => {
          f.addEventListener("change", function () {
            const f = this.files[0];
            const reader = new FileReader();
            const url = reader.readAsDataURL(f);
            reader.addEventListener("loadend", function () {
              const images = document.querySelectorAll(".images img");
              images[i].src = this.result;
              // if (images.forEach(g => g.src.length > 0) == -1)
              // {
              //     console.log("all images loaded")
              // }
              let count = 0;
              for (const im of images) {
                if (im.src.length > 0) {
                  count++;
                }
              }
              if (count == 2) {
                console.log("all images loaded");
                formData = new FormData();
                formData.append("source", images[0].src);
                formData.append("new", images[1].src);
                fetch("/api.php", { method: "POST", body: formData })
                  .then((res) => res.json())
                  .then((res) => {
                    const s = res.source.TextDetections.map(
                      (item) => item.DetectedText
                    ).join("");
                    const n = res.new.TextDetections.map(
                      (item) => item.DetectedText
                    ).join("");
                    console.log(Diff);
                    let diff = Diff.diffChars(s, n, { ignoreCase: false });
                    let fd = new FormData();
                    fd.append("a", s);
                    fd.append("b", n);
                    fetch("http://apis.998990.xyz/dish/diffs", {
                      method: "POST",
                      body: fd,
                    })
                      .then((res) => res.json())
                      .then((res) => {
                        var fragment = document.createDocumentFragment();
                        res.data.forEach((r) => {
                          var span = document.createElement("span");
                          let color = 'gray'
                          switch (r.action) {
                            case '=':
                              color = 'gray'
                              span.appendChild(document.createTextNode(r.new_element))
                              break;
                            case '+':
                              color = 'green'
                              span.appendChild(document.createTextNode(r.new_element))
                              break;
                            case '-':
                              color = 'red'
                              span.appendChild(document.createTextNode(r.old_element))
                              break;
                            case '!':
                              color = 'blue'
                              span.appendChild(document.createTextNode(r.new_element))
                              break;
                            default:
                              break;
                          }
                          span.style.color = color
                          fragment.appendChild(span);
                        });
                        document
                          .querySelector(".item-source")
                          .appendChild(sourceFragment);
                        document
                          .querySelector(".item-new")
                          .appendChild(fragment);
                      })
                      .catch((err) => {
                        console.log(err);
                      });
                    var sourceFragment = document.createDocumentFragment();
                    sourceFragment.appendChild(document.createTextNode(s));
                  });
              }
              reader.removeEventListener("loadend", this);
            });
          });
        });
        console.log(files);
      })();
      // fetch('api.php').then(res=>res.text()).then(data=>{
      //     console.log(data);
      // })
    </script>
  </body>
</html>
